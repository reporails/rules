# Schema definition for sources registry
# Used by: agents writing/updating rules, contributors

schema_version: 3

# =============================================================================
# TIER DERIVATION
# =============================================================================
# Tiers are NOT stored on sources - they are derived from source weights.
# A rule's tier is determined by its backing sources:
#
#   core:         max(backing_source_weights) >= 0.8
#   experimental: max(backing_source_weights) < 0.8
#
# This means:
#   - Official (1.0) or Research (0.8) backing → core rule
#   - Community (0.4) only backing → experimental rule
#   - Mixed backing → strongest source wins (e.g., official + community = core)

tier_derivation:
  core:
    condition: "max(source_weights) >= 0.8"
    sources: [official, research]
    meaning: "Vendor-confirmed or empirically validated"
  experimental:
    condition: "max(source_weights) < 0.8"
    sources: [community]
    meaning: "Community patterns, not yet validated"

# =============================================================================
# ADMISSION CRITERIA
# =============================================================================
# Quality gates for source admission. Sources below minimum_weight are rejected.

admission_criteria:
  minimum_weight: 0.4
  description: "Sources below this weight are rejected"

  requirements_by_type:
    official:
      weight_range: [1.0, 1.0]
      criteria:
        - "Vendor documentation or official announcement"
        - "Published on vendor domain or official channel"

    research:
      weight_range: [0.8, 0.9]
      criteria:
        - "Has measured data or empirical results"
        - "Methodology is described"
        - "Results are specific and reproducible"
        - "Author credentials verifiable"

    community:
      weight_range: [0.4, 0.5]
      criteria:
        - "Author has verifiable identity/credibility"
        - "Claims are specific, not vague advice"
        - "Preferably corroborated by another source"
        - "Published on recognized platform"

  rejection:
    weight_below: 0.4
    auto_reject:
      - "Anonymous or unverifiable author"
      - "No specific claims (vague advice only)"
      - "Single anecdote without supporting data"
      - "Contradicts official sources without evidence"
      - "Self-promotional without substance"
      - "Outdated (>2 years without validation)"

# =============================================================================
# SOURCE REGISTRY STRUCTURE
# =============================================================================
# Sources are grouped by scope for efficient lookup.
# Each source contains specific claims that back specific rules.
# =============================================================================

structure:
  description: |
    Top-level keys are scope identifiers:
    - "generic": Sources applicable to all agents
    - "claude", "copilot", "codex", etc.: Agent-specific sources

    Each source has id, url, type, weight, and claims array.

  example: |
    generic:
      - id: source-id
        url: "https://..."
        type: official
        weight: 1.0
        claims:
          - id: claim-id
            text: "The specific claim"
            rules: [S1, C2]

    claude:
      - id: another-source
        url: "https://..."
        type: community
        weight: 0.4
        claims:
          - id: another-claim
            text: "Another claim"
            rules: [E1]

# =============================================================================
# SOURCE FIELDS
# =============================================================================

fields:
  id:
    required: true
    type: string
    pattern: "^[a-z][a-z0-9-]*$"
    description: "Unique identifier (lowercase, hyphens)"

  url:
    required: true
    type: string
    format: url
    description: "Canonical URL to the source"

  type:
    required: true
    type: enum
    values: [official, research, community]
    description: |
      Source origin type:
      - official: Vendor documentation (Anthropic, GitHub, OpenAI, etc.)
      - research: Empirical studies, measured data
      - community: Blog posts, guides, tutorials, framework patterns

  weight:
    required: true
    type: number
    min: 0.4
    max: 1.0
    description: |
      Authority weight for tier derivation:
      - 1.0: Official vendor documentation
      - 0.8: Research with measured data
      - 0.4: Community blog posts, tutorials

  accessed:
    required: false
    type: string
    format: date
    description: "Date when source was last accessed (YYYY-MM-DD)"

  title:
    required: false
    type: string
    description: "Human-readable title (if different from page title)"

  claims:
    required: true
    type: array
    min_items: 1
    description: "Specific claims extracted from this source"
    items:
      id:
        required: true
        type: string
        pattern: "^[a-z][a-z0-9-]*$"
        description: "Claim identifier (unique within source)"

      text:
        required: true
        type: string
        max_length: 200
        description: "The actual claim (quote or close paraphrase)"

      rules:
        required: true
        type: array
        items:
          type: string
          pattern: "^([A-Z]+_)?[SCEGM][0-9]+$"
        description: "Rule IDs that this claim backs"

      quote:
        required: false
        type: boolean
        default: false
        description: "True if text is a direct quote"

      section:
        required: false
        type: string
        description: "Section/heading in source where claim appears"

# =============================================================================
# VALIDATION
# =============================================================================

validation:
  - rule: "id must be unique across ALL sources"
  - rule: "claim.id must be unique within source"
  - rule: "claim.rules must reference valid rule IDs"
  - rule: "url must be accessible"
  - rule: "Every rule in claim.rules should have backed_by reference back"
  - rule: "type must be one of: official, research, community"

# =============================================================================
# EXAMPLES
# =============================================================================

examples:
  official_source: |
    - id: claude-code-best-practices
      url: "https://code.claude.com/docs/en/best-practices"
      type: official
      weight: 1.0
      claims:
        - id: size-limit
          text: "Keep CLAUDE.md under 300 lines"
          quote: true
          section: "File Organization"
          rules: [S1]

        - id: use-imports
          text: "Use @imports for detailed documentation"
          quote: false
          section: "Progressive disclosure"
          rules: [S2]

  community_source: |
    - id: spec-writing-for-agents
      url: "https://addyosmani.com/blog/good-spec/"
      type: community
      weight: 0.4
      claims:
        - id: three-tier-boundaries
          text: "Use three-tier boundaries: Always do, Ask first, Never do"
          rules: [C4, C10]
          # Note: If C4 has no official/research backing,
          # it will be 'experimental' tier (max weight = 0.4 < 0.8)
