# Schema definition for rule frontmatter
# Used by: ails check, ails validate, agents, contributors

schema_version: 2

# Migration from v1:
#   - confidence now includes 'confirmed' level
#   - backed_by field required for confirmed/high confidence
#   - Confidence validation rules updated

# =============================================================================
# RULE TYPES
# =============================================================================
# deterministic: OpenGrep decides. No LLM.
# semantic: OpenGrep first, LLM fills gaps.
# =============================================================================

types:
  - deterministic
  - semantic

categories:
  - structure
  - content
  - efficiency
  - governance
  - maintenance

severities:
  - critical
  - high
  - medium
  - low

# =============================================================================
# FIELDS
# =============================================================================

reserved_agent_prefixes:
  - CLAUDE
  - COPILOT
  - CODEX
  - CURSOR
  - WINDSURF
  - CLINE
  - AIDER
  - CONTINUE

fields:
  id:
    required: true
    type: string
    pattern:
      core: "^[SCEGM][0-9]+$"
      agent: "^[A-Z]+_[SCEGM][0-9]+$"
      custom: "^[A-Z]{3,}_[SCEGM][0-9]+$"
    description: |
      Core: category + number (S1)
      Agent: reserved prefix + category + number (CLAUDE_S1, COPILOT_E1)
      Custom: 3+ letter prefix + category + number (ACME_S1, USR_G3)
      Note: Agent prefix must be in reserved_agent_prefixes. Custom prefix must not.

  title:
    required: true
    type: string
    max_length: 64
    description: "Human-readable name (max 64 chars)"

  category:
    required: true
    type: enum
    values: [structure, content, efficiency, governance, maintenance]

  type:
    required: true
    type: enum
    values: [deterministic, semantic]

  confidence:
    required: true
    type: enum
    values: [confirmed, high, medium, low]
    description: |
      Evidence-based confidence levels:

      - confirmed: Official claim EXISTS + Research VALIDATES it works
                   Requires: backed_by with official (weight 1.0) AND research (weight >= 0.8)
                   Example: "Anthropic says keep under 300 lines" + "Study measured improvement"

      - high: Official source states the recommendation
              Requires: backed_by with official source (weight >= 1.0)
              Example: "Anthropic recommends using @imports"

      - medium: Community consensus or research without official backing
                Requires: backed_by with research (weight >= 0.8) OR 2+ community (weight >= 0.4)
                Example: "Multiple community posts agree on this pattern"

      - low: Reporails methodology without external validation
             Requires: backed_by is empty OR only methodology sources
             Example: "We believe this is good practice based on experience"

  backed_by:
    required: false
    type: array
    description: "Source claims that back this rule"
    items:
      source:
        required: true
        type: string
        description: "Source ID from sources.yml"
      claim:
        required: true
        type: string
        description: "Claim ID within that source"

  checks:
    required: true
    type: array
    description: "What OpenGrep detects"
    items:
      id:
        required: true
        type: string
        description: "Must match rules[].id in corresponding .yml. Format: {rule_id}-{suffix}"
      name:
        required: true
        type: string
        description: "Human-readable description"
      severity:
        required: true
        type: enum
        values: [critical, high, medium, low]

  question:
    required_if: "type == semantic"
    type: string
    description: "What LLM evaluates after OpenGrep runs"

  criteria:
    required_if: "type == semantic"
    type: array
    items:
      type: string
    description: "How LLM decides (list of conditions)"

  sources:
    required: false
    type: array
    items:
      type: string
      format: url
    description: "URLs to supporting references (docs, articles, research papers, resources)"

  see_also:
    required: false
    type: array
    items:
      type: string
      pattern: "^([A-Z]+_)?[SCEGM][0-9]+$"
    description: "Related rule IDs"

# =============================================================================
# TEMPLATE VARIABLES
# =============================================================================

template_variables:
  universal:
    description: "Required for ALL agents — core rules may only use these"
    variables:
      main_instruction_file:
        description: "Primary instruction file (document-level rules apply here)"
        example: "**/CLAUDE.md"
      instruction_files:
        description: "All instruction files (main + supplementary)"
        example: ["**/CLAUDE.md", ".claude/rules/**/*.md"]

  agent_specific:
    description: "Only agents that support them — requires rule in agents/{agent}/rules/"
    variables:
      supplementary_files:
        description: "Rule snippet files (excludes main)"
        example: ".claude/rules/**/*.md"
      rules_dir:
        description: "Rules directory path"
        example: ".claude/rules"
      skills_dir:
        description: "Skills directory path"
        example: ".claude/skills"
      local_file:
        description: "Local/personal instruction file"
        example: "CLAUDE.local.md"

# =============================================================================
# VALIDATION
# =============================================================================

validation:
  # Contract between .md and .yml
  - rule: "Every checks[].id must match a rules[].id in the .yml file"
  - rule: "Every rules[].id in .yml must match a checks[].id in the .md file"
  - rule: "checks[].id must start with the rule ID followed by hyphen"

  # Type-specific requirements
  - rule: "Semantic rules must have question + criteria"
  - rule: "Deterministic rules must not have question + criteria"

  # Source of truth
  - rule: "Severity in .md is source of truth (overrides .yml)"

  # Field constraints
  - rule: "title must be max 64 characters"
  - rule: "confidence is required"

  # ID format
  - rule: "Core rule IDs must match pattern ^[SCEGM][0-9]+$"
  - rule: "Agent rule IDs must match pattern ^[A-Z]+_[SCEGM][0-9]+$"
  - rule: "Custom rule IDs must match pattern ^[A-Z]{3,}_[SCEGM][0-9]+$"
  - rule: "Agent rule prefix must be in reserved_agent_prefixes"
  - rule: "Custom rule prefix must NOT be in reserved_agent_prefixes"

  # References
  - rule: "see_also must reference valid rule IDs"
  - rule: "sources must be valid URLs"

  # Evidence chain
  - rule: "backed_by[].source must exist in sources.yml"
  - rule: "backed_by[].claim must exist in that source's claims"

  # Confidence validation (updated for v2)
  - rule: |
      confidence: confirmed requires:
        - At least one backed_by source with weight >= 1.0 (official)
        - At least one backed_by source with weight >= 0.8 AND type = research
  - rule: |
      confidence: high requires:
        - At least one backed_by source with weight >= 1.0 (official)
        - Does NOT require research validation
  - rule: |
      confidence: medium requires:
        - At least one backed_by source with weight >= 0.8 (research)
        - OR two or more backed_by sources with weight >= 0.4 (community)
  - rule: |
      confidence: low requires:
        - backed_by is empty
        - OR all backed_by sources are type: methodology

  # Template variable restrictions
  - rule: "Core rules (in core/) may only use {{main_instruction_file}} or {{instruction_files}}"
  - rule: "Agent-specific variables (supplementary_files, rules_dir, skills_dir) require rule in agents/{agent}/rules/"

# =============================================================================
# EXAMPLES
# =============================================================================

examples:
  confirmed: |
    ---
    # Confirmed = official source + research validation
    id: S1
    title: Size Limits
    category: structure
    type: deterministic
    confidence: confirmed
    backed_by:
      - source: claude-code-best-practices  # official, weight 1.0
        claim: keep-concise
      - source: claude-md-optimization-study  # research, weight 0.8
        claim: optimization-improvement
    checks:
      - id: S1-root-too-long
        name: Root file > 200 lines
        severity: critical
      - id: S1-many-sections
        name: 6+ sections in large file
        severity: high
    sources:
      - "https://docs.anthropic.com/en/docs/claude-code/best-practices"
    see_also: [CLAUDE_M7, C1]
    ---

  deterministic: |
    ---
    id: C9
    title: Has Project Description
    category: content
    type: deterministic
    confidence: high
    backed_by:
      - source: claude-code-best-practices
        claim: include-core-files
    checks:
      - id: C9-no-description
        name: Missing project description section
        severity: high
    sources:
      - "https://docs.anthropic.com/en/docs/claude-code/best-practices"
    see_also: [C1]
    ---

  semantic: |
    ---
    id: G3
    title: Security Rules Ownership
    category: governance
    type: semantic
    confidence: medium
    checks:
      - id: G3-ownership-patterns
        name: Security ownership indicators
        severity: high
    question: "Given what was found, are security rules properly owned?"
    criteria:
      - Security rules have designated owners
      - Owners have relevant expertise
      - Review process exists for security changes
    sources:
      - "https://docs.anthropic.com/en/docs/claude-code/security"
    see_also: [G1, G2]
    ---

  agent_specific: |
    ---
    id: CLAUDE_S1
    title: Memory Block Format
    category: structure
    type: deterministic
    confidence: high
    checks:
      - id: CLAUDE_S1-invalid-memory
        name: Invalid memory block syntax
        severity: medium
    sources:
      - "https://docs.anthropic.com/en/docs/claude-code/memory"
    see_also: [S1]
    ---

  custom: |
    ---
    id: ACME_S1
    title: Internal Doc Size Limits
    category: structure
    type: deterministic
    confidence: medium
    checks:
      - id: ACME_S1-too-long
        name: Internal docs > 150 lines
        severity: medium
    sources:
      - "https://wiki.acme.corp/engineering/claude-guidelines"
    see_also: [S1]
    ---