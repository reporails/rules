# Schema definition for rule frontmatter
# Used by: ails check, ails validate, agents, contributors

version: 5

# =============================================================================
# RULE TYPES
# =============================================================================
# deterministic: OpenGrep decides. No LLM.
# semantic: OpenGrep first, LLM fills gaps.
# =============================================================================

types:
  - deterministic
  - semantic

categories:
  - structure
  - content
  - efficiency
  - governance
  - maintenance

severities:
  - critical
  - high
  - medium
  - low

# =============================================================================
# RULE RESOLUTION STACK
# =============================================================================
# Rules are resolved in layers (bottom to top). Higher layers win.
#
#   ┌─────────────────────────────────────┐
#   │ User/Local                          │  Can: define, override, exclude
#   ├─────────────────────────────────────┤
#   │ Agent                               │  Can: define, override, exclude core
#   ├─────────────────────────────────────┤
#   │ Core                                │  Universal baseline (all agents)
#   └─────────────────────────────────────┘
#
# Resolution for each file:
#   1. Collect applicable core rules
#   2. Apply agent modifications:
#      - excludes: remove rules entirely
#      - overrides (config): adjust severity
#      - overrides (files): replace patterns
#   3. Add agent-specific rules (CLAUDE_*, CURSOR_*, etc.)
#   4. Apply user modifications (same as agent)
#   5. Add user-specific rules (USR_*, custom prefix)
#
# Namespaces:
#   - Core: S1, S2, S3... (universal)
#   - Agent: CLAUDE_S1, CLAUDE_S2... (agent's own sequence)
#   - User: USR_S1, ACME_S1... (user's own sequence)
#
# Override mechanisms:
#   - Exclude rule: excludes: [S1] in config
#   - Change severity: overrides: {S1-check: {severity: low}} in config
#   - Change pattern: agents/{agent}/overrides/S1.yml
#
# =============================================================================

# =============================================================================
# FIELDS
# =============================================================================

reserved_agent_prefixes:
  - CLAUDE
  - COPILOT
  - CODEX
  - CURSOR
  - WINDSURF
  - CLINE
  - AIDER
  - CONTINUE

fields:
  id:
    required: true
    type: string
    pattern:
      core: "^[SCEGM][0-9]+$"
      agent: "^[A-Z]+_[SCEGM][0-9]+$"
      custom: "^[A-Z]{3,}_[SCEGM][0-9]+$"
    description: |
      IMPORTANT: Namespaces are SEPARATE. Agent numbers are independent of core.

      Core: category + number (S1, S2, S3...)
        - Universal rules, apply to all agents
        - Located in core/{category}/{id}-{slug}/

      Agent: prefix + category + number (CLAUDE_S1, CLAUDE_S2...)
        - Agent-specific rules, OWN numbering sequence
        - CLAUDE_S1 is Claude's first structure rule, NOT related to core S1
        - Located in agents/{agent}/rules/{id}-{slug}/

      Custom: 3+ letter prefix + category + number (ACME_S1, USR_G3)
        - Organization or user-specific rules

      Note: Agent prefix must be in reserved_agent_prefixes. Custom prefix must not.

      To OVERRIDE core patterns (not define new rules), use:
        agents/{agent}/overrides/{rule_id}.yml
      See agent.schema.yml for override file format.

  title:
    required: true
    type: string
    max_length: 64
    description: "Human-readable name (max 64 chars)"

  category:
    required: true
    type: enum
    values: [structure, content, efficiency, governance, maintenance]

  type:
    required: true
    type: enum
    values: [deterministic, semantic]

  # NOTE: 'confidence' field removed in schema v4.
  # Tier (core/experimental) is derived from backed_by source weights:
  #   core:         max(backing_source_weights) >= 0.8
  #   experimental: max(backing_source_weights) < 0.8 (or no backing)
  # See sources.schema.yml for tier derivation details.

  backed_by:
    required: false
    type: array
    description: "Source claims that back this rule"
    items:
      source:
        required: true
        type: string
        description: "Source ID from sources.yml"
      claim:
        required: true
        type: string
        description: "Claim ID within that source"

  checks:
    required: true
    type: array
    description: "What OpenGrep detects"
    items:
      id:
        required: true
        type: string
        description: "Must match rules[].id in corresponding .yml. Format: {rule_id}-{suffix}"
      name:
        required: true
        type: string
        description: "Human-readable description"
      severity:
        required: true
        type: enum
        values: [critical, high, medium, low]
      pattern_confidence:
        required: false
        type: enum
        values: [very_high, high, medium, low, very_low]
        default: medium
        description: |
          How precisely the OpenGrep pattern captures what it claims to detect.
          Consumers: LLM pattern generation (improvement targeting), CLI telemetry.

          very_high: Exact structural match (line count, file exists). Don't touch.
          high:      Tight regex, tested, rare false positives. Minor refinement only.
          medium:    Reasonable regex, some edge cases. Review test cases, tighten.
          low:       Broad match, known false positives. Rewrite with more context.
          very_low:  Placeholder or minimal pattern. Full rethink needed.

          Derivable from: test case count + observed false positive rate.

  question:
    required_if: "type == semantic"
    type: string
    description: "What LLM evaluates after OpenGrep runs"

  criteria:
    required_if: "type == semantic"
    type: array
    items:
      type: string
    description: "How LLM decides (list of conditions)"

  sources:
    required: false
    type: array
    items:
      type: string
      format: url
    description: "URLs to supporting references (docs, articles, research papers, resources)"

  see_also:
    required: false
    type: array
    items:
      type: string
      pattern: "^([A-Z]+_)?[SCEGM][0-9]+$"
    description: "Related rule IDs"

# =============================================================================
# TEMPLATE VARIABLES
# =============================================================================

template_variables:
  universal:
    description: "Required for ALL agents — core rules may only use these"
    variables:
      main_instruction_file:
        description: "Primary instruction file (document-level rules apply here)"
        example: "**/CLAUDE.md"
      instruction_files:
        description: "All instruction files (main + supplementary)"
        example: ["**/CLAUDE.md", ".claude/rules/**/*.md"]

  agent_specific:
    description: "Only agents that support them — requires rule in agents/{agent}/rules/"
    variables:
      supplementary_files:
        description: "Rule snippet files (excludes main)"
        example: ".claude/rules/**/*.md"
      rules_dir:
        description: "Rules directory path"
        example: ".claude/rules"
      skills_dir:
        description: "Skills directory path"
        example: ".claude/skills"
      local_file:
        description: "Local/personal instruction file"
        example: "CLAUDE.local.md"
      managed_settings_linux:
        description: "Path to managed settings file on Linux"
        example: "/etc/claude-code/managed-settings.json"
      managed_settings_macos:
        description: "Path to managed settings file on macOS"
        example: "/Library/Application Support/ClaudeCode/managed-settings.json"
      managed_settings_windows:
        description: "Path to managed settings file on Windows"
        example: "C:/Program Files/ClaudeCode/managed-settings.json"

# =============================================================================
# VALIDATION
# =============================================================================

validation:
  # Contract between .md and .yml
  - rule: "Every checks[].id must match a rules[].id in the .yml file"
  - rule: "Every rules[].id in .yml must match a checks[].id in the .md file"
  - rule: "checks[].id must start with the rule ID followed by hyphen"

  # Type-specific requirements
  - rule: "Semantic rules must have question + criteria"
  - rule: "Deterministic rules must not have question + criteria"

  # Source of truth
  - rule: "Severity in .md is source of truth (overrides .yml)"

  # Field constraints
  - rule: "title must be max 64 characters"

  # ID format
  - rule: "Core rule IDs must match pattern ^[SCEGM][0-9]+$"
  - rule: "Agent rule IDs must match pattern ^[A-Z]+_[SCEGM][0-9]+$"
  - rule: "Custom rule IDs must match pattern ^[A-Z]{3,}_[SCEGM][0-9]+$"
  - rule: "Agent rule prefix must be in reserved_agent_prefixes"
  - rule: "Custom rule prefix must NOT be in reserved_agent_prefixes"

  # References
  - rule: "see_also must reference valid rule IDs"
  - rule: "sources must be valid URLs"

  # Evidence chain
  - rule: "backed_by[].source must exist in sources.yml"
  - rule: "backed_by[].claim must exist in that source's claims"

  # Tier derivation (replaces confidence validation from v3)
  - rule: |
      Tier is derived, not stored. Computed from backed_by:
        - core: at least one backing source with weight >= 0.8 (official or research)
        - experimental: all backing sources have weight < 0.8, or backed_by is empty

  # Template variable restrictions
  - rule: "Core rules (in core/) may only use {{main_instruction_file}} or {{instruction_files}}"
  - rule: "Agent-specific variables (supplementary_files, rules_dir, skills_dir) require rule in agents/{agent}/rules/"

# =============================================================================
# EXAMPLES
# =============================================================================

examples:
  core_with_backing: |
    ---
    # Tier: core (derived — backed by official source, weight 1.0)
    id: S1
    title: Size Limits
    category: structure
    type: deterministic
    backed_by:
      - source: claude-code-best-practices  # official, weight 1.0
        claim: keep-concise
    checks:
      - id: S1-root-too-long
        name: Root file > 200 lines
        severity: critical
        pattern_confidence: very_high  # exact line count match
      - id: S1-many-sections
        name: 6+ sections in large file
        severity: high
        pattern_confidence: high  # heading count, tight match
    sources:
      - "https://docs.anthropic.com/en/docs/claude-code/best-practices"
    see_also: [CLAUDE_M2, C1]
    ---

  experimental_no_backing: |
    ---
    # Tier: experimental (derived — no backing sources)
    id: S4
    title: YAML Backbone
    category: structure
    type: deterministic
    backed_by: []
    checks:
      - id: S4-no-backbone
        name: Missing backbone.yml
        severity: medium
    see_also: [G4]
    ---

  deterministic: |
    ---
    id: C9
    title: Has Project Description
    category: content
    type: deterministic
    backed_by:
      - source: claude-code-best-practices
        claim: include-core-files
    checks:
      - id: C9-no-description
        name: Missing project description section
        severity: high
    sources:
      - "https://docs.anthropic.com/en/docs/claude-code/best-practices"
    see_also: [C1]
    ---

  semantic: |
    ---
    id: G2
    title: Security Rules Ownership
    category: governance
    type: semantic
    backed_by:
      - source: anthropic-teams-claude-code
        claim: security-review
    checks:
      - id: G2-ownership-patterns
        name: Security ownership indicators
        severity: high
    question: "Given what was found, are security rules properly owned?"
    criteria:
      - Security rules have designated owners
      - Owners have relevant expertise
      - Review process exists for security changes
    sources:
      - "https://docs.anthropic.com/en/docs/claude-code/security"
    see_also: [G1]
    ---

  agent_specific: |
    ---
    # Agent rules use SEPARATE namespace
    # CLAUDE_S1 = Claude's first structure rule (not override of core S1)
    id: CLAUDE_S1
    title: Skill Size Limits
    category: structure
    type: deterministic
    backed_by: []
    checks:
      - id: CLAUDE_S1-skill-too-long
        name: Skill file exceeds size limit
        severity: medium
    sources:
      - "https://docs.anthropic.com/en/docs/claude-code/skills"
    see_also: [S1]  # conceptually related, not an override
    ---

  custom: |
    ---
    id: ACME_S1
    title: Internal Doc Size Limits
    category: structure
    type: deterministic
    backed_by: []
    checks:
      - id: ACME_S1-too-long
        name: Internal docs > 150 lines
        severity: medium
    sources:
      - "https://wiki.acme.corp/engineering/claude-guidelines"
    see_also: [S1]
    ---